<!--pages/room/room.wxml-->
<view class="container">
  <!-- æˆ¿é—´å¤´éƒ¨ -->
  <view class="room-header">
    <view class="header-main">
      <text class="room-title">{{story.title}}</text>
      <view class="room-meta">
        <text class="room-theme">{{story.theme}}</text>
        <text class="room-id">ID: {{story.id}}</text>
      </view>
    </view>
    <view class="header-actions">
      <view class="action-icon" bindtap="shareRoom">ğŸ“¤</view>
      <view class="action-icon" bindtap="showSettings">âš™ï¸</view>
    </view>
  </view>

  <!-- æˆ¿é—´çŠ¶æ€ -->
  <view class="room-status">
    <view class="status-item">
      <text class="status-label">çŠ¶æ€</text>
      <view class="status-value {{story.status}}">
        {{statusText[story.status]}}
      </view>
    </view>
    <view class="status-item">
      <text class="status-label">è¿›åº¦</text>
      <view class="status-value">
        <text class="progress-text">{{story.turns.length}}/5 è½®</text>
      </view>
    </view>
    <view class="status-item" wx:if="{{story.status === 'playing'}}">
      <text class="status-label">å½“å‰å›åˆ</text>
      <view class="status-value highlight">
        â° {{timeLimits[story.timeLimit]}}
      </view>
    </view>
  </view>

  <!-- å‚ä¸è€…åˆ—è¡¨ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">å‚ä¸è€…</text>
      <text class="section-subtitle">{{story.participants.length}}/{{story.maxParticipants}}</text>
    </view>
    <scroll-view scroll-x class="participants-scroll">
      <view class="participants-list">
        <view 
          class="participant-card {{index === story.currentTurn ? 'active' : ''}}" 
          wx:for="{{story.participants}}" 
          wx:key="index"
        >
          <view class="participant-avatar">
            <text class="avatar-text">{{item.nickName.charAt(0)}}</text>
            <view class="turn-indicator" wx:if="{{index === story.currentTurn}}">ğŸ¯</view>
          </view>
          <text class="participant-name">{{item.nickName}}</text>
          <text class="participant-role" wx:if="{{index === 0}}">æˆ¿ä¸»</text>
          <text class="participant-turn" wx:if="{{index === story.currentTurn && story.status === 'playing'}}">
            è½®åˆ°TA
          </text>
        </view>
        
        <!-- ç©ºä½ -->
        <view 
          class="participant-card empty" 
          wx:for="{{emptySlots}}" 
          wx:key="index"
          bindtap="inviteFriend"
        >
          <view class="participant-avatar">
            <text class="avatar-text">+</text>
          </view>
          <text class="participant-name">é‚€è¯·å¥½å‹</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ•…äº‹æ—¶é—´çº¿ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">æ•…äº‹å‘å±•</text>
      <text class="section-subtitle">{{story.turns.length}}ä¸ªæ®µè½</text>
    </view>
    
    <view class="timeline">
      <view 
        class="timeline-item {{index === story.turns.length - 1 ? 'latest' : ''}}" 
        wx:for="{{story.turns}}" 
        wx:key="index"
      >
        <view class="timeline-marker">
          <view class="marker-dot"></view>
          <view class="marker-line" wx:if="{{index < story.turns.length - 1}}"></view>
        </view>
        
        <view class="timeline-content">
          <view class="turn-header">
            <text class="author">{{item.user}}</text>
            <text class="time">{{formatTime(item.timestamp)}}</text>
          </view>
          <text class="turn-content">{{item.content}}</text>
          <view class="turn-actions" wx:if="{{index === story.turns.length - 1}}">
            <text class="action-like">â¤ï¸ {{likeCount}}</text>
            <text class="action-comment">ğŸ’¬</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-timeline" wx:if="{{story.turns.length === 0}}">
        <image src="/images/empty-timeline.png" class="empty-image"></image>
        <text class="empty-text">æ•…äº‹è¿˜æ²¡æœ‰å¼€å§‹</text>
        <text class="empty-desc">å¿«å†™ä¸‹ç¬¬ä¸€ä¸ªæ®µè½å§</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <button 
      class="action-button primary {{isMyTurn ? 'highlight' : ''}}" 
      bindtap="startWriting"
      disabled="{{!isMyTurn && story.status === 'playing'}}"
    >
      <view class="button-content">
        <text class="button-icon">âœï¸</text>
        <text class="button-text">
          {{getButtonText()}}
        </text>
      </view>
    </button>
    
    <view class="secondary-actions">
      <button class="action-button secondary" bindtap="inviteFriend">
        <text class="button-icon">ğŸ‘¥</text>
        <text class="button-text">é‚€è¯·</text>
      </button>

      <button class="action-button secondary" bindtap="saveStoryToCloud">
        <text class="button-icon">â˜ï¸</text>
        <text class="button-text">ä¿å­˜</text>
      </button>
      
      <button class="action-button secondary" bindtap="viewStoryRules">
        <text class="button-icon">ğŸ“–</text>
        <text class="button-text">è§„åˆ™</text>
      </button>
      
      <button 
        class="action-button secondary" 
        bindtap="viewCompleteStory"
        wx:if="{{story.status === 'completed'}}"
      >
        <text class="button-icon">ğŸ‰</text>
        <text class="button-text">å®Œæˆ</text>
      </button>
    </view>
  </view>

  <!-- é‚€è¯·å¼¹çª— -->
  <view class="modal {{showInviteModal ? 'show' : ''}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é‚€è¯·å¥½å‹</text>
        <view class="modal-close" bindtap="hideInviteModal">Ã—</view>
      </view>
      
      <view class="invite-content">
        <view class="invite-qrcode">
          <text class="qrcode-placeholder">ğŸ“±</text>
          <text class="qrcode-text">å°ç¨‹åºç </text>
        </view>
        
        <view class="invite-info">
          <text class="invite-title">{{story.title}}</text>
          <text class="invite-desc">æ‰«æäºŒç»´ç åŠ å…¥æ•…äº‹åˆ›ä½œ</text>
          
          <view class="room-code">
            <text class="code-label">æˆ¿é—´ID</text>
            <view class="code-value">
              <text class="code-text">{{story.id}}</text>
              <text class="code-copy" bindtap="copyRoomCode">å¤åˆ¶</text>
            </view>
          </view>
        </view>
      </view>
      
      <button class="share-button" bindtap="shareToFriend">åˆ†äº«ç»™å¥½å‹</button>
    </view>
  </view>
</view>