<!--pages/write/write.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="write-header">
    <view class="header-left">
      <view class="back-button" bindtap="goBack">â†</view>
      <text class="header-title">ç»­å†™æ•…äº‹</text>
    </view>
    <view class="header-right">
      <text class="word-count">{{content.length}}/500</text>
    </view>
  </view>

  <!-- æ•…äº‹ä¸Šä¸‹æ–‡ -->
  <view class="context-section">
    <view class="section-header">
      <text class="section-title">æ•…äº‹å½“å‰å†…å®¹</text>
      <text class="section-tip">å‚è€ƒå‰æ–‡ä¿æŒè¿è´¯</text>
    </view>
    
    <scroll-view scroll-y class="context-scroll" scroll-into-view="{{'turn-' + (previousTurns.length - 1)}}">
      <view class="context-list">
        <view 
          class="context-item" 
          wx:for="{{previousTurns}}" 
          wx:key="index"
          id="turn-{{index}}"
        >
          <view class="context-header">
            <text class="context-author">{{item.user}}</text>
            <text class="context-time">{{formatTime(item.timestamp)}}</text>
          </view>
          <text class="context-content">{{item.content}}</text>
        </view>
        
        <!-- å½“å‰å†™ä½œæç¤º -->
        <view class="writing-prompt">
          <text class="prompt-icon">âœï¸</text>
          <text class="prompt-text">è½®åˆ°ä½ äº†ï¼è¯·ç»§ç»­åˆ›ä½œ...</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å†™ä½œåŒºåŸŸ -->
  <view class="writing-section">
    <view class="section-header">
      <text class="section-title">æˆ‘çš„ç»­å†™</text>
      <text class="section-tip">å»ºè®®100-300å­—</text>
    </view>
    
    <textarea 
      class="writing-textarea" 
      placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„åˆ›æ„ç»­å†™ï¼Œæ¨åŠ¨æ•…äº‹å‘å±•..."
      placeholder-class="textarea-placeholder"
      bindinput="onContentInput"
      bindfocus="onTextareaFocus"
      bindblur="onTextareaBlur"
      value="{{content}}"
      maxlength="500"
      show-confirm-bar="{{false}}"
      auto-height
    />
    
    <!-- å†™ä½œè¾…åŠ© -->
    <view class="writing-assist">
      <view class="assist-item" bindtap="clearContent">
        <text class="assist-icon">ğŸ—‘ï¸</text>
        <text class="assist-text">æ¸…ç©º</text>
      </view>
      
      <view class="assist-item" bindtap="toggleAIEnhanced">
        <text class="assist-icon">{{useAIEnhanced ? 'âœ…' : 'âšª'}}</text>
        <text class="assist-text">AIæ¶¦è‰²</text>
      </view>
      
      <view class="assist-item" bindtap="getAISuggestions">
        <text class="assist-icon">ğŸ’¡</text>
        <text class="assist-text">{{gettingSuggestions ? 'æ€è€ƒä¸­...' : 'AIå»ºè®®'}}</text>
      </view>
    </view>
  </view>

  <!-- AIå»ºè®®åŒºåŸŸ -->
  <view class="suggestions-section" wx:if="{{suggestions.length > 0}}">
    <view class="section-header">
      <text class="section-title">AIåˆ›ä½œå»ºè®®</text>
      <text class="section-tip">ç‚¹å‡»ä½¿ç”¨å»ºè®®</text>
    </view>
    
    <view class="suggestions-grid">
      <view 
        class="suggestion-card" 
        wx:for="{{suggestions}}" 
        wx:key="index"
        bindtap="useSuggestion"
        data-index="{{index}}"
      >
        <view class="suggestion-header">
          <text class="suggestion-number">#{{index + 1}}</text>
          <text class="suggestion-use" wx:if="{{!usedSuggestions[index]}}">ç‚¹å‡»ä½¿ç”¨</text>
          <text class="suggestion-used" wx:else>å·²ä½¿ç”¨</text>
        </view>
        <text class="suggestion-content">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- å†™ä½œç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{content.length}}</text>
        <text class="stat-label">å­—æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{estimateReadingTime}}s</text>
        <text class="stat-label">é˜…è¯»æ—¶é—´</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{getParagraphCount()}}</text>
        <text class="stat-label">æ®µè½</text>
      </view>
      <view class="stat-item">
        <text class="stat-value {{content.length >= 100 ? 'good' : 'warn'}}">
          {{content.length >= 100 ? 'ğŸ‘' : 'âš ï¸'}}
        </text>
        <text class="stat-label">å»ºè®®</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <button 
      class="action-button preview" 
      bindtap="previewStory"
      disabled="{{!content.trim()}}"
    >
      <text class="button-icon">ğŸ‘ï¸</text>
      <text class="button-text">é¢„è§ˆ</text>
    </button>
    
    <button 
      class="action-button submit {{canSubmit ? 'active' : ''}}" 
      bindtap="submitStory"
      disabled="{{!canSubmit || submitting}}"
    >
      <view class="button-content">
        <text class="button-icon">{{submitting ? 'â³' : 'ğŸš€'}}</text>
        <text class="button-text">
          {{submitting ? 'æäº¤ä¸­...' : 'æäº¤ç»­å†™'}}
        </text>
      </view>
      <text class="submit-tip" wx:if="{{useAIEnhanced}}">(AIæ¶¦è‰²)</text>
    </button>
  </view>

  <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
  <view class="modal {{showPreviewModal ? 'show' : ''}}">
    <view class="modal-content preview-modal">
      <view class="modal-header">
        <text class="modal-title">é¢„è§ˆæˆ‘çš„ç»­å†™</text>
        <view class="modal-close" bindtap="hidePreviewModal">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="preview-scroll">
        <view class="preview-content">
          <!-- åŸæœ‰æ•…äº‹ -->
          <view class="preview-original">
            <text class="preview-section-title">åŸæœ‰æ•…äº‹</text>
            <view class="original-content">
              <text wx:for="{{previousTurns}}" wx:key="index">
                {{item.user}}ï¼š{{item.content}}\n\n
              </text>
            </view>
          </view>
          
          <!-- æˆ‘çš„ç»­å†™ -->
          <view class="preview-new">
            <text class="preview-section-title">æˆ‘çš„ç»­å†™</text>
            <view class="new-content">
              <text class="author-tag">{{userInfo.nickName}}ï¼š</text>
              <text class="new-text">{{previewContent}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="preview-actions">
        <button class="preview-button secondary" bindtap="hidePreviewModal">ç»§ç»­ä¿®æ”¹</button>
        <button class="preview-button primary" bindtap="confirmSubmit">ç¡®è®¤æäº¤</button>
      </view>
    </view>
  </view>
</view>